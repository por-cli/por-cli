#!/usr/bin/env bash
HIS="${XDG_STATE_HOME:-$HOME/.local/state}/por-cli/watch.history"

MODE=$1

spinner() {
  local pid=$1
  local delay=0.1
  local spin='|/-\'
  while kill -0 $pid 2>/dev/null; do
    for i in $(seq 0 3); do
      printf "\r[%c] Loading..." "${spin:$i:1}"
      sleep $delay
    done
  done
  printf "\r                "
  printf "\r"
}

preview(){
  local img="$1"
  if [ -n "$TERMUX_VERSION" ]; then
    curl -s "$img" | chafa --size=${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES} -
    return
  else
    kitty icat --clear --transfer-mode=memory --stdin=no --place=${FZF_PREVIEW_COLUMNS}x${FZF_PREVIEW_LINES}@0x0 "$img" 
    return
  fi
}

player () {
  vid="$1"
  if [ -n "$TERMUX_VERSION" ]; then
    am start -n is.xyz.mpv/is.xyz.mpv.MPVActivity -e filepath $vid
    return
  else
    {
      mpv --msg-level=all=no $vid
    }&
  pid=$!;
  spinner "$pid";
  wait "$pid";
  return
  fi
}

export -f spinner
export -f preview
export -f player

if [[ "$MODE" == "-h" || "$MODE" == "--help" ]]; then
  cat <<EOF
por-cli â€” quick search & watch helper

Usage:
  por-cli           # interactive search (choose provider)
  por-cli -r        # resume from watch history
  por-cli -h        # show help

Options:
  -r            Resume & pick from history
  -h, --help    Show this help menu

History file:
  $HIS

Examples:
  por-cli           # search normally
  por-cli -r        # pick from past watched videos
EOF
exit 0
fi

if [ "$MODE" = "-r" ]; then

  if [ ! -s $HIS ]; then
    echo "watch a video first"
    exit 0
  fi
  cat $HIS |
    awk '!seen[$1]++' |
    fzf \
    --bind 'enter:execute(
      url={1};
      echo "$url" >> "${XDG_STATE_HOME:-$HOME/.local/state}/por-cli/watch.history";
      playlist=$(curl -sSf --retry 20 --retry-delay 2 --retry-all-errors "$url" |
        grep -oP "https://[^\\\"]+\\.m3u8" |
        head -n1 )
      bash -c "player $playlist"
      )'
      exit 0

    else

      provider=`echo "xhamster spankbang eporner" | tr ' ' '\n'`
      selected=`printf "$provider" | fzf`

      if [[ -z $selected ]]; then
        echo "No provider selected" >&2
        exit 2
      fi

      read -rp "Search: " SEARCH
      ENCODED_SEARCH=${SEARCH// /+}

      if [[ $selected == "xhamster" ]]; then

        {
          PAGE=$( curl -sSf --retry 20 --retry-delay 2 --retry-all-errors --connect-timeout 10 --max-time 30 "https://xhamster1.desi/search/$ENCODED_SEARCH" 2>/dev/null|
            grep -B2 '<li class="next">' |
            grep -oP 'data-page="\K\d+' |
            tail -n 1
          )
          echo "$PAGE" > /tmp/page.tmp
        }&
      pid=$!

      spinner "$pid"
      wait "$pid"
      PAGE=$(cat /tmp/page.tmp)
      rm /tmp/page.tmp
      {
        for ((i = 1; i <= PAGE; i++)); do
          curl -sSf --retry 20 --retry-delay 2 --retry-all-errors --connect-timeout 10 --max-time 30 https://xhamster1.desi/search/$ENCODED_SEARCH?page=$i 2>/dev/null \
            | grep -oP '<a[^>]+href="https://[^"]+/videos/[^"]+"[^>]*>.*?</a>' \
            | sed -nE 's/.*href="([^"]+)".*aria-label="([^"]+)".*(data-src|src)="([^"]+\.jpg)".*/\1\t\2\t\4/p' 
          done
          notify-send "Pages loaded" "All $PAGE pages fetched. Select a video."
        } | 
          awk '!seen[$1]++' |
          fzf --delimiter=$'\t' --with-nth=2 \
          --preview 'bash -c "preview {3}"' \
          --bind "enter:execute(
            $(typeset -f spinner)
            $(typeset -f player)
            url='{1}';
            tmp=\$(mktemp);
            {
              echo \"\$url\" >> \"${XDG_STATE_HOME:-$HOME/.local/state}/por-cli/watch.history\";
              playlist=\$(curl -sSf --retry 20 --retry-delay 2 --retry-all-errors \
                --connect-timeout 10 --max-time 30 \"\$url\" 2>/dev/null \
                | grep -oP 'https://[^\" ]+\\.m3u8' \
                | head -n1);
              echo \"\$playlist\" > \"\$tmp\";
            } &
          pid=\$!;
          spinner \"\$pid\";
          wait \"\$pid\";
          playlist=\$(cat \"\$tmp\");
          rm -f \"\$tmp\";
          [ -n \"\$playlist\" ] && player \"\$playlist\"
          )"
          exit 0
        elif [[ $selected == "spankbang" ]]; then
          { 
            PAGE=$(curl -L -s "https://spankbang.party/s/$ENCODED_SEARCH" -A "Mozilla/5.0 (compatible; MSIE 7.01; Windows NT 5.0)" 2>/dev/null |
              grep -oP "/s/$ENCODED_SEARCH/\K\d+(?=/)" |
              sort -n |
              tail -n1
            )
            echo "$PAGE" > /tmp/page.tmp
          }&
        pid=$!

        spinner "$pid"
        wait "$pid"
        PAGE=$(cat /tmp/page.tmp)
        rm /tmp/page.tmp
        {
          for ((i = 1; i <= PAGE; i++)); do
            curl -L -v "https://spankbang.party/s/$ENCODED_SEARCH/$i" -A "Mozilla/5.0 (compatible; MSIE 7.01; Windows NT 5.0)" 2>/dev/null |
              tr '\n' ' ' |
              grep -oP '<div[^>]+data-testid="video-item".*?</div>\s*</div>' |
              sed -E 's|.*<img[^>]+src="([^"]+)".*?<a[^>]+href="([^"]+/video/[^"]+)".*?title="([^"]+)".*|\2\t\3\t\1|' |
              sed '1,8d' 
            done
            notify-send "Pages loaded" "All $PAGE pages fetched. Select a video."
          } | 
            fzf --delimiter=$'\t' --with-nth=2 \
            --preview 'bash -c "preview {3}"' \
            --bind "enter:execute(
              $(typeset -f spinner)
              $(typeset -f player)
              url=https://spankbang.party{1};
              tmp=\$(mktemp);
              {
                echo \"\$url\" >> \"\${XDG_STATE_HOME:-$HOME/.local/state}/por-cli/watch.history\";
                playlist=\$(curl -L -v -s \"\$url\" -A \"Mozilla/5.0 (compatible; MSIE 7.01; Windows NT 5.0)\" 2>/dev/null |
                  tr '\n' ' ' |
                  grep -oP \"'m3u8'\\s*:\\s*\\[\\s*'\\K[^']+\" );
                echo \"\$playlist\" > \"\$tmp\";
                }&
              pid=\$!;
              spinner \"\$pid\";
              wait \"\$pid\";
              playlist=\$(cat \"\$tmp\");
              rm -f \"\$tmp\";
              [ -n \"\$playlist\" ] && player \"\$playlist\"
              )"
              exit 0
            else
              echo "WORK IN PROGRESS FOR $selected" >&2
              exit 1
      fi
fi 
